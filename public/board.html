<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Jeopardy Board</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            background: #00008b;
            color: #fff;
            font-family: 'Impact', sans-serif;
            margin: 0;
            overflow: hidden;
        }

        /* Hintergrundbild-Handling */
        body {
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease-in-out;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: -1;
        }

        /* Das Raster fÃ¼r die Fragen */
        #game-grid {
            display: grid;
            gap: 10px;
            padding: 20px;
            height: 80vh;
            text-align: center;
        }

        .cat-header {
            color: white;
            font-size: 1.5rem;
            text-transform: uppercase;
            text-shadow: 2px 2px 0 #000;
            background: #00008b;
            border: 3px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            text-align: center;
            word-break: break-word;
        }

        /* Karten */
        .q-card {
            background: #0000cc;
            border: 3px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #ffcc00;
            cursor: pointer;
            text-shadow: 3px 3px 0 #000;
        }

        .q-card.played {
            opacity: 0;
            visibility: hidden;
        }

        /* Wichtig: Header in Zeile 1 zwingen */
        #game-grid .cat-header {
            grid-row: 1;
        }

        /* --- OVERLAY STYLES (Korrigiert) --- */
        #question-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #00008b;
            z-index: 50;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 5vh 5vw;
            box-sizing: border-box;
        }

        #question-text,
        #answer-text {
            color: white;
            text-align: center;
            word-wrap: break-word;
            word-break: break-word;
            max-width: 90%;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }

        #question-text {
            font-size: 8vh;
            line-height: 1.2;
            min-height: 10vh;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #answer-text {
            font-size: 6vh;
            background: #000066;
            display: none;
        }

        #media-container {
            max-width: 80%;
            max-height: 50vh;
            margin-bottom: 20px;
        }

        #media-container img,
        #media-container video {
            max-width: 100%;
            max-height: 100%;
            display: block;
            object-fit: contain;
            border: 5px solid white;
        }

        /* Spieler Leiste */
        #player-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 15vh;
            background: #111;
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
            border-top: 3px solid white;
        }

        .player-card {
            border: 2px solid white;
            padding: 10px 20px;
            font-size: 1.5rem;
            background: #00008b;
        }

        .player-card.buzzing {
            background: #fff;
            color: #00008b;
            border-color: #ffcc00;
            transform: scale(1.2);
        }

        #q-map {
            height: 60vh;
            /* 60% der BildschirmhÃ¶he */
            width: 80%;
            /* 80% der Breite */
            margin: 20px auto;
            border: 5px solid white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
            display: none;
            /* StandardmÃ¤ÃŸig versteckt */
            background: #ccc;
            z-index: 100;
            /* Sicherstellen, dass sie oben liegt */
        }

        /* Wrapper fÃ¼r den Marker auf der Karte */
        .marker-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Zentriert Punkt und Text horizontal */
            width: max-content;
            /* WICHTIG: Passt Breite an den Text an */
            transform: translate(-50%, -50%);
            /* Zentriert den gesamten Wrapper exakt auf der Koordinate */
        }

        /* Der farbige Punkt */
        .marker-dot {
            width: 16px;
            height: 16px;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            margin-bottom: 5px;
            /* Abstand zum Text */
        }

        /* Der schwarze Hintergrund fÃ¼r den Text */
        .marker-label {
            background: rgba(0, 0, 0, 0.85);
            /* 85% Schwarz */
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            text-align: center;
            white-space: nowrap;
            /* Verhindert Umbruch */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body>

    <div id="game-grid">
        <h1 style="width:100%; text-align:center; margin-top: 200px;">WARTE AUF SPIEL...</h1>
    </div>

    <div id="question-overlay">
        <div id="media-container"></div>
        <div id="q-map"></div>
        <div id="question-text">Die Frage steht hier...</div>
        <div id="answer-text">Die Antwort steht hier...</div>
    </div>

    <div id="player-bar"></div>

    <div id="qr-overlay" style="
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background-color: rgba(0, 0, 0, 0.95); z-index: 1000; 
        display: none; flex-direction: column; align-items: center; justify-content: center;
    ">
        <h1 style="color: white; font-size: 4rem; margin-bottom: 40px;">Zum Spiel beitreten</h1>
        <div id="qrcode-container" style="background: white; padding: 20px; border-radius: 10px;"></div>
        <p style="color: white; font-size: 2rem; margin-top: 40px;">Gehe zu: <span id="join-url"></span></p>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentGame = null;
        let qrCodeVisible = false;
        let currentQuestion = null;
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get('room');

        if (roomCode) {
            socket.emit('board_join_session', roomCode);

            // QR Code URL anpassen, damit Spieler direkt mit Raum joinen kÃ¶nnen (optional)
            // new QRCode(..., `http://DEINE-IP:3000/player.html?room=${roomCode}`);
        } else {
            alert("Fehler: Kein Raum-Code in der URL!");
        }

        // Falls Session beendet wird
        socket.on('session_ended', () => {
            alert("Der Host hat die Sitzung beendet.");
            window.close();
        });

        // --- HELFER: SchriftgrÃ¶ÃŸe anpassen ---
        function adjustFontSize(elementId) {
            const el = document.getElementById(elementId);
            if (!el || !el.innerText) return;

            let size = 8; // StartgrÃ¶ÃŸe in vh
            el.style.fontSize = size + 'vh';

            // Verkleinern, solange der Text Ã¼berlÃ¤uft
            while ((el.scrollWidth > el.clientWidth || el.scrollHeight > el.clientHeight) && size > 2) {
                size -= 0.5;
                el.style.fontSize = size + 'vh';
            }
        }

        socket.on('board_init_game', (game) => {
            console.log("Spieldaten empfangen:", game);
            currentGame = game;

            // Titel setzen (optional)
            document.title = game.title || "Jeopardy Board";

            // Hintergrundbild setzen (falls im Spiel definiert)
            if (game.boardBackgroundPath) {
                document.body.style.backgroundImage = `url('${game.boardBackgroundPath}')`;
            }

            // Das Raster aufbauen
            renderGrid();
        });

        // --- FRAGE ANZEIGEN (KORRIGIERT) ---
        let mapInstance = null; // Globale Variable zum Speichern der Karten-Instanz

        socket.on('board_show_question', (question) => {
            console.log("hier31");
            console.log("BOARD: Empfange Frage...", question); // Debugging
            console.log("hier32");
            try {
                // 1. Alle Elemente holen
                const overlay = document.getElementById('question-overlay');
                const mediaCont = document.getElementById('media-container');
                const mapDiv = document.getElementById('q-map');
                const qText = document.getElementById('question-text');
                const aText = document.getElementById('answer-text');

                // 2. Overlay sofort einschalten (damit Inhalte gerendert werden kÃ¶nnen)
                if (overlay) {
                    overlay.style.display = 'flex';
                    overlay.style.opacity = '1';
                }

                // 3. Alte Inhalte verstecken/leeren
                if (aText) aText.style.display = 'none';
                if (mediaCont) {
                    mediaCont.innerHTML = '';
                    mediaCont.style.display = 'none';
                }
                if (mapDiv) {
                    mapDiv.style.display = 'none';
                }

                // Karte resetten falls nÃ¶tig
                if (mapInstance) {
                    mapInstance.remove();
                    mapInstance = null;
                }

                // 4. TEXT SETZEN (Fallback, falls Text leer ist)
                if (qText) {
                    qText.style.display = 'block'; // Sicherstellen, dass er sichtbar ist
                    qText.innerText = question.text ? question.text : "";
                    // Wenn gar kein Text und kein Bild da ist, Platzhalter anzeigen (optional)
                    if (!question.text && question.type === 'standard' && !question.mediaPath) {
                        qText.innerText = "(Kein Text)";
                    }
                }

                // 5. ENTSCHEIDUNG: MAP oder STANDARD
                if (question.type === 'map') {
                    // === MAP MODUS ===
                    console.log("BOARD: Map Modus aktiviert");
                    if (mapDiv) {
                        mapDiv.style.display = 'block';

                        // Minimale VerzÃ¶gerung, damit Container sichtbar ist bevor Leaflet lÃ¤dt
                        setTimeout(() => {
                            const isCustom = question.location && question.location.isCustomMap;
                            const customPath = question.location && question.location.customMapPath;

                            if (isCustom && customPath) {
                                // Custom Map
                                var img = new Image();
                                img.onload = function () {
                                    mapInstance = L.map('q-map', {
                                        crs: L.CRS.Simple,
                                        minZoom: -2, maxZoom: 2, zoomSnap: 0.1,
                                        zoomControl: false, attributionControl: false
                                    });
                                    var bounds = [[0, 0], [this.height, this.width]];
                                    L.imageOverlay(customPath, bounds).addTo(mapInstance);
                                    mapInstance.fitBounds(bounds);
                                };
                                img.src = customPath;
                            } else {
                                // Weltkarte
                                mapInstance = L.map('q-map', {
                                    zoomControl: false,
                                    attributionControl: false
                                }).setView([51.16, 10.45], 5);
                                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
                            }
                        }, 100);
                    }
                } else {
                    // === STANDARD MODUS (Medien) ===
                    console.log("BOARD: Standard Modus (Medien: " + question.mediaPath + ")");

                    if (question.mediaPath && mediaCont) {
                        mediaCont.style.display = 'block';
                        const ext = question.mediaPath.split('.').pop().toLowerCase();

                        if (['mp4', 'webm', 'ogg', 'mov'].includes(ext)) {
                            const vid = document.createElement('video');
                            vid.src = question.mediaPath;
                            vid.controls = true;
                            vid.autoplay = true;
                            vid.style.maxWidth = '100%'; vid.style.maxHeight = '50vh';
                            mediaCont.appendChild(vid);
                        } else if (['mp3', 'wav'].includes(ext)) {
                            const aud = document.createElement('audio');
                            aud.src = question.mediaPath;
                            aud.controls = true;
                            aud.autoplay = true;
                            mediaCont.appendChild(aud);
                            // Visueller Platzhalter fÃ¼r Audio
                            qText.innerHTML += "<br>ðŸŽµ <i>Audio wird abgespielt...</i>";
                        } else {
                            const img = document.createElement('img');
                            img.src = question.mediaPath;
                            img.style.maxWidth = '100%'; img.style.maxHeight = '50vh';
                            mediaCont.appendChild(img);
                        }
                    }
                }

                // 6. SchriftgrÃ¶ÃŸe erst kurz danach anpassen (Browser braucht Zeit zum Rendern)
                setTimeout(() => {
                    if (qText) adjustFontSize('question-text');
                }, 50);

                // 7. Karte im Grid als "gespielt" markieren
                const card = document.getElementById(`card-${question.catIndex}-${question.qIndex}`);
                if (card) card.classList.add('played');

            } catch (err) {
                console.error("BOARD ERROR:", err);
                alert("Fehler beim Anzeigen der Frage: " + err.message);
            }
        });

        socket.on('board_reveal_answer', () => {
            if (!currentQuestion) return;

            const textBox = document.getElementById('question-text');
            textBox.innerHTML = `<span style="color: #4CAF50; font-size: 0.6em; display:block; margin-bottom:10px;">LÃ–SUNG:</span>${currentQuestion.answerText || ''}`;

            // --- ENTSCHEIDUNG: MAP ODER STANDARD? ---

            if (currentQuestion.type === 'map' && currentQuestion.location) {
                // === FALL A: KARTEN-ANTWORT ===

                // Karte muss sichtbar bleiben
                const mapDiv = document.getElementById('q-map');
                if (mapDiv) mapDiv.style.display = 'block';

                // Andere Medien verstecken
                document.getElementById('media-container').style.display = 'none';

                // MARKER JETZT HINZUFÃœGEN
                if (mapInstance) {
                    const { lat, lng } = currentQuestion.location;

                    // Marker erstellen
                    const marker = L.marker([lat, lng]).addTo(mapInstance);

                    // Optional: Karte sanft zum Marker bewegen (falls der Spieler sie verschoben hat)
                    mapInstance.flyTo([lat, lng], 13, {
                        duration: 2.0 // Dauer des Fluges in Sekunden
                    });

                    // Optional: Popup Ã¶ffnen
                    // marker.bindPopup("Hier ist es!").openPopup();
                }

            } else {
                // === FALL B: NORMALE ANTWORT (Bilder/Musik) ===

                // Karte verstecken & aufrÃ¤umen
                const mapDiv = document.getElementById('q-map');
                if (mapDiv) mapDiv.style.display = 'none';

                if (mapInstance) {
                    mapInstance.remove();
                    mapInstance = null;
                }

                // Medien anzeigen
                const mediaCont = document.getElementById('media-container');
                mediaCont.innerHTML = '';

                const path = currentQuestion.answerMediaPath;
                if (path) {
                    mediaCont.style.display = 'block';
                    renderMedia(path, mediaCont, true); // true = Autoplay
                } else {
                    mediaCont.style.display = 'none';
                }
            }

            setTimeout(() => adjustFontSize('question-text'), 10);
        });

        function renderMedia(path, container, autoPlay = false) {
            container.style.display = 'block';

            // Dateiendung prÃ¼fen
            const ext = path.split('.').pop().toLowerCase();

            if (['mp4', 'webm', 'ogg', 'mov'].includes(ext)) {
                // VIDEO
                const vid = document.createElement('video');
                vid.src = path;
                if (autoPlay) vid.autoplay = true;
                vid.controls = true;
                vid.style.maxWidth = '100%';
                vid.style.maxHeight = '50vh';
                container.appendChild(vid);

            } else if (['mp3', 'wav', 'mpeg'].includes(ext)) {
                // AUDIO (Musik)
                const audio = document.createElement('audio');
                audio.src = path;
                if (autoPlay) {
                    audio.autoplay = true;
                    // Versuch, Audio abzuspielen (kann vom Browser blockiert werden, wenn keine Interaktion stattfand)
                    audio.play().catch(e => console.log("Autoplay blockiert:", e));
                }
                audio.controls = true; // Steuerelemente anzeigen
                container.appendChild(audio);

                // Icon fÃ¼r Audio anzeigen
                const icon = document.createElement('div');
                icon.innerHTML = 'ðŸŽµ';
                icon.style.fontSize = '5rem';
                container.appendChild(icon);

            } else {
                // BILD
                const img = document.createElement('img');
                img.src = path;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '50vh';
                container.appendChild(img);
            }
        }

        // --- ZURÃœCK ZUM BOARD ---
        socket.on('board_hide_question', () => {
            document.getElementById('question-overlay').style.display = 'none';
            document.getElementById('media-container').innerHTML = "";

            // Audio stoppen (falls noch lÃ¤uft)
            const audios = document.querySelectorAll('audio, video');
            audios.forEach(a => a.pause());
        });

        // --- STANDARD FUNKTIONEN ---
        function renderPlayerBar(playersData) {
            const bar = document.getElementById('player-bar');
            bar.innerHTML = "";
            for (const id in playersData) {
                const p = playersData[id];
                const div = document.createElement('div');
                div.className = 'player-card';
                div.id = 'p-' + id;
                div.innerText = `${p.name} (${p.score})`;
                bar.appendChild(div);
            }
        }

        function generateQrCode() {
            const url = window.location.href.replace('board.html', 'player.html');
            document.getElementById('join-url').innerText = url;
            const container = document.getElementById('qrcode-container');
            container.innerHTML = '';
            new QRCode(container, { text: url, width: 400, height: 400, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H });
        }

        function renderGrid() {
            const grid = document.getElementById('game-grid');
            grid.innerHTML = ''; // Alte Inhalte lÃ¶schen

            if (!currentGame || !currentGame.categories) return;

            // CSS Grid Spaltenanzahl anpassen
            const catCount = currentGame.categories.length;
            grid.style.gridTemplateColumns = `repeat(${catCount}, 1fr)`;

            // 1. Kopfzeile (Kategorien)
            currentGame.categories.forEach(cat => {
                const header = document.createElement('div');
                header.className = 'cat-header';
                header.innerText = cat.name;
                grid.appendChild(header);
            });

            // 2. Fragen-Kacheln (vertikal iterieren: Zeile fÃ¼r Zeile)
            // Wir gehen davon aus, dass alle Kategorien gleich viele Fragen haben (z.B. 5)
            const maxQuestions = Math.max(...currentGame.categories.map(c => c.questions.length));

            for (let i = 0; i < maxQuestions; i++) {
                currentGame.categories.forEach((cat, catIndex) => {
                    const q = cat.questions[i];
                    const card = document.createElement('div');
                    card.className = 'q-card';
                    card.id = `card-${catIndex}-${i}`; // ID zum Ausblenden spÃ¤ter

                    if (q) {
                        card.innerText = q.points;
                    } else {
                        card.style.visibility = 'hidden'; // Leere Kachel
                    }
                    grid.appendChild(card);
                });
            }
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            var R = 6371; // Radius der Erde in km
            var dLat = deg2rad(lat2 - lat1);
            var dLon = deg2rad(lon2 - lon1);
            var a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var d = R * c; // Distanz in km
            return d.toFixed(1); // 1 Nachkommastelle
        }

        // --- LISTENERS ---
        socket.on('load_game_on_board', (game) => {
            console.log('Quiz geladen:', game.title);
            currentGame = game;

            if (currentGame.boardBackgroundPath) {
                document.body.style.backgroundImage = `url(${currentGame.boardBackgroundPath})`;
            } else {
                document.body.style.backgroundImage = 'none';
                document.body.style.backgroundColor = '#1a1a1a';
            }
            renderGrid();

            // QR Code Logik beim Start
            const qrOverlay = document.getElementById('qr-overlay');
            generateQrCode();
            qrCodeVisible = true;
            qrOverlay.style.display = 'flex';
        });

        socket.on('board_toggle_qr', () => {
            const qrOverlay = document.getElementById('qr-overlay');
            if (qrOverlay.style.display === 'none' || qrOverlay.style.display === '') {
                if (!qrCodeVisible) { generateQrCode(); qrCodeVisible = true; }
                qrOverlay.style.display = 'flex';
            } else {
                qrOverlay.style.display = 'none';
            }
        });

        socket.on('update_scores', renderPlayerBar);
        socket.on('update_player_list', renderPlayerBar); // Fallback

        socket.on('player_won_buzz', (data) => {
            document.querySelectorAll('.player-card').forEach(c => c.classList.remove('buzzing'));
            const winner = document.getElementById('p-' + data.id);
            if (winner) winner.classList.add('buzzing');
        });

        socket.on('buzzers_unlocked', () => {
            document.querySelectorAll('.player-card').forEach(c => c.classList.remove('buzzing'));
        });

        socket.on('board_reveal_map_results', (data) => {
            const { results, players, target } = data;

            // --- 1. LÃ–SUNGS-MARKER (ZIEL) ---
            const targetIcon = L.divIcon({
                className: 'target-icon',
                html: `<div style="width:20px; height:20px; background:#00ff00; border:2px solid black; border-radius:50%; box-shadow:0 0 10px #00ff00;"></div>
                       <div style="position:absolute; top:-25px; left:-20px; background:black; color:#00ff00; padding:2px 5px; font-weight:bold; border:1px solid #00ff00;">LÃ–SUNG</div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            L.marker([target.lat, target.lng], { icon: targetIcon, zIndexOffset: 1000 }).addTo(mapInstance);

            // Bounds initialisieren (um spÃ¤ter zu zoomen)
            const bounds = [[target.lat, target.lng]];

            // --- 2. SPIELER-MARKER (SCHLEIFE) ---
            Object.keys(results).forEach(playerId => {
                const res = results[playerId];     // Das Ergebnis (Lat, Lng, Distanz)
                const player = players[playerId];  // Die Spieler-Info (Name, Farbe)

                if (!player) return; // Falls Spieler nicht mehr da ist

                // Text formatieren
                let distText = target.isCustomMap
                    ? Math.round(res.distance) + " px"
                    : res.distance.toFixed(1) + " km";

                let winnerLabel = res.isWinner
                    ? '<br><span style="color:#00ff00; font-weight:900;">â˜… GEWINNER â˜…</span>'
                    : '';

                let winnerStyle = res.isWinner ? 'border: 3px solid #00ff00; width: 18px; height: 18px;' : '';

                // HTML fÃ¼r den Marker erstellen
                const pIcon = L.divIcon({
                    className: 'custom-map-marker',
                    html: `
                        <div class="marker-wrapper">
                            <div class="marker-dot" style="background:${player.color}; ${winnerStyle}"></div>
                            <div class="marker-label">
                                <span style="color:${player.color}; font-weight:bold;">${player.name}</span><br>
                                ${distText}
                                ${winnerLabel}
                            </div>
                        </div>
                    `,
                    iconSize: null, // Wichtig fÃ¼r CSS-GrÃ¶ÃŸe
                    iconAnchor: [0, 0] // Wichtig fÃ¼r CSS-Zentrierung
                });

                // Marker auf Karte setzen
                L.marker([res.lat, res.lng], { icon: pIcon }).addTo(mapInstance);

                // Linie zur LÃ¶sung zeichnen
                L.polyline([[target.lat, target.lng], [res.lat, res.lng]], {
                    color: player.color,
                    weight: res.isWinner ? 4 : 2,
                    opacity: 0.8,
                    dashArray: '5, 10'
                }).addTo(mapInstance);

                // Koordinate zu Bounds hinzufÃ¼gen
                bounds.push([res.lat, res.lng]);
            });

            // --- 3. ZOOM ANPASSEN ---
            if (bounds.length > 0) {
                // Etwas Padding, damit Marker nicht am Rand kleben
                mapInstance.fitBounds(bounds, { padding: [100, 100], maxZoom: 15 });
            }
        });
    </script>
</body>

</html>