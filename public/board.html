<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Jeopardy Board</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { background: #00008b; color: #fff; font-family: 'Impact', sans-serif; margin: 0; overflow: hidden; }
        
        /* Hintergrundbild-Handling */
        body {
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            transition: background-image 0.5s ease-in-out;
        }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.4); z-index: -1;
        }

        /* Das Raster f√ºr die Fragen */
        #game-grid {
            display: grid;
            gap: 10px; padding: 20px; height: 80vh; text-align: center;
        }
        
        .cat-header { 
            color: white; font-size: 1.5rem; text-transform: uppercase; 
            text-shadow: 2px 2px 0 #000; 
            background: #00008b; border: 3px solid #fff; 
            display: flex; align-items: center; justify-content: center; 
            padding: 10px; text-align: center; word-break: break-word;
        }
        
        /* Karten */
        .q-card {
            background: #0000cc; border: 3px solid #fff; display: flex; align-items: center; justify-content: center;
            font-size: 3rem; color: #ffcc00; cursor: pointer; text-shadow: 3px 3px 0 #000;
        }
        .q-card.played { opacity: 0; visibility: hidden; }

        /* Wichtig: Header in Zeile 1 zwingen */
        #game-grid .cat-header { grid-row: 1; }

        /* --- OVERLAY STYLES (Korrigiert) --- */
        #question-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #00008b; z-index: 50;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            padding: 5vh 5vw; box-sizing: border-box;
        }

        #question-text, #answer-text {
            color: white; text-align: center;
            word-wrap: break-word; word-break: break-word;
            max-width: 90%; padding: 20px; margin: 20px 0; border-radius: 10px;
        }
        
        #question-text {
            font-size: 8vh; line-height: 1.2; min-height: 10vh;
            background: rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; justify-content: center;
        }

        #answer-text {
            font-size: 6vh; background: #000066; display: none;
        }

        #media-container {
            max-width: 80%; max-height: 50vh; margin-bottom: 20px;
        }
        #media-container img, #media-container video {
            max-width: 100%; max-height: 100%; display: block; object-fit: contain;
            border: 5px solid white;
        }
        
        /* Spieler Leiste */
        #player-bar {
            position: fixed; bottom: 0; width: 100%; height: 15vh; background: #111; 
            display: flex; justify-content: center; gap: 20px; align-items: center; border-top: 3px solid white;
        }
        .player-card { border: 2px solid white; padding: 10px 20px; font-size: 1.5rem; background: #00008b; }
        .player-card.buzzing { background: #fff; color: #00008b; border-color: #ffcc00; transform: scale(1.2); }
        #q-map {
            height: 60vh; /* 60% der Bildschirmh√∂he */
            width: 80%;   /* 80% der Breite */
            margin: 20px auto;
            border: 5px solid white;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            display: none; /* Standardm√§√üig versteckt */
            background: #ccc;
            z-index: 100; /* Sicherstellen, dass sie oben liegt */
        }
    </style>
</head>
<body>

    <div id="game-grid">
        <h1 style="width:100%; text-align:center; margin-top: 200px;">WARTE AUF SPIEL...</h1>
    </div>

    <div id="question-overlay">
        <div id="media-container"></div>
        <div id="q-map"></div>
        <div id="question-text">Die Frage steht hier...</div>
        <div id="answer-text">Die Antwort steht hier...</div>
    </div>

    <div id="player-bar"></div>
    
    <div id="qr-overlay" style="
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background-color: rgba(0, 0, 0, 0.95); z-index: 1000; 
        display: none; flex-direction: column; align-items: center; justify-content: center;
    ">
        <h1 style="color: white; font-size: 4rem; margin-bottom: 40px;">Zum Spiel beitreten</h1>
        <div id="qrcode-container" style="background: white; padding: 20px; border-radius: 10px;"></div>
        <p style="color: white; font-size: 2rem; margin-top: 40px;">Gehe zu: <span id="join-url"></span></p>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentGame = null;
        let qrCodeVisible = false;
        let currentQuestion = null;

        // --- HELFER: Schriftgr√∂√üe anpassen ---
        function adjustFontSize(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.style.fontSize = '8vh'; 
            let currentSize = 8; 
            
            for (let i = 0; i < 10; i++) {
                if (element.scrollWidth > element.clientWidth || element.scrollHeight > element.clientHeight) {
                    currentSize -= 0.5;
                    element.style.fontSize = `${currentSize}vh`;
                } else {
                    break; 
                }
                if (currentSize <= 2) break; 
            }
        }

        // --- FRAGE ANZEIGEN (KORRIGIERT) ---
        let mapInstance = null; // Globale Variable zum Speichern der Karten-Instanz

        socket.on('board_show_question', (data) => {
            const { catIndex, qIndex, question } = data;
            currentQuestion = question; // <--- WICHTIG: Frage f√ºr sp√§ter speichern

            // Reset
            const mediaCont = document.getElementById('media-container');
            mediaCont.innerHTML = "";
            mediaCont.style.display = 'none';
            
            const mapDiv = document.getElementById('q-map');
            if(mapDiv) mapDiv.style.display = 'none';

            // Text anzeigen
            document.getElementById('question-text').innerText = question.questionText;

            // --- ENTSCHEIDUNG: KARTE ODER NORMALES MEDIUM? ---
            
            if (question.type === 'map' && question.location) {
                // === FALL A: KARTEN-FRAGE ===
                mapDiv.style.display = 'block';

                // WICHTIG: Leaflet braucht einen Moment, um die Gr√∂√üe des Divs zu erkennen
                setTimeout(() => {
                    // Alte Karte l√∂schen, falls vorhanden (Cleanup)
                    if (mapInstance) {
                        mapInstance.remove();
                        mapInstance = null;
                    }

                    const lat = question.location.lat;
                    const lng = question.location.lng;

                    // Karte initialisieren
                    mapInstance = L.map('q-map', {
                        center: [lat, lng],
                        zoom: 13,
                        zoomControl: false, // Optional: Steuerelemente ausblenden f√ºr cleanen Look
                        attributionControl: false 
                    });

                    // Pr√ºfen: Custom Map (eigenes Bild) oder Standard (OpenStreetMap)?
                    if (question.location.isCustomMap && question.location.customMapPath) {
                        // -> CUSTOM MAP (Bild als Karte)
                        const imageUrl = question.location.customMapPath;
                        // Wir definieren feste Grenzen f√ºr das Bild, damit der Marker passt
                        // (Das muss zur Logik in create.html passen)
                        const imageBounds = [[-500, -500], [500, 500]]; 
                        
                        L.imageOverlay(imageUrl, imageBounds).addTo(mapInstance);
                        mapInstance.fitBounds(imageBounds);
                        
                        // Marker setzen (Koordinaten m√ºssen im Bild-System sein)
                        L.marker([lat, lng]).addTo(mapInstance);

                    } else {
                        // -> STANDARD MAP (OpenStreetMap)
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            maxZoom: 19
                        }).addTo(mapInstance);

                        // Marker setzen
                        L.marker([lat, lng]).addTo(mapInstance);
                    }
                    
                    // Layout aktualisieren erzwingen (verhindert graue Kacheln)
                    mapInstance.invalidateSize();

                }, 100); // 100ms Verz√∂gerung reicht meistens

            } else {
                // === FALL B: NORMALE MEDIEN (Bilder/Videos) ===
                if (question.mediaPath) {
                renderMedia(question.mediaPath, mediaCont);
            }
            }

            // Overlay anzeigen
            document.getElementById('question-overlay').style.display = 'flex';
            adjustFontSize('question-text'); 
            
            const card = document.getElementById(`card-${catIndex}-${qIndex}`);
            if(card) card.classList.add('played');
        });

        socket.on('board_reveal_answer', () => {
            if (!currentQuestion) return;

            // A. Text √§ndern
            const textBox = document.getElementById('question-text');
            textBox.innerHTML = `<span style="color: #4CAF50; font-size: 0.6em; display:block; margin-bottom:10px;">L√ñSUNG:</span>${currentQuestion.answerText || ''}`;

            // B. Medien-Container leeren (altes Frage-Bild weg)
            const mediaCont = document.getElementById('media-container');
            mediaCont.innerHTML = ''; 
            mediaCont.style.display = 'none';

            // Map weg
            const mapDiv = document.getElementById('q-map');
            if(mapDiv) mapDiv.style.display = 'none';

            // C. Antwort-Medien anzeigen (Audio/Bild/Video)
            const path = currentQuestion.answerMediaPath;
            
            if (path) {
                mediaCont.style.display = 'block';
                renderMedia(path, mediaCont, true); // true = Autoplay f√ºr Antwort
            }

            // Schriftgr√∂√üe anpassen
            setTimeout(() => adjustFontSize('question-text'), 10);
        });

        function renderMedia(path, container, autoPlay = false) {
            container.style.display = 'block';
            
            // Dateiendung pr√ºfen
            const ext = path.split('.').pop().toLowerCase();

            if (['mp4', 'webm', 'ogg', 'mov'].includes(ext)) {
                // VIDEO
                const vid = document.createElement('video');
                vid.src = path;
                if(autoPlay) vid.autoplay = true;
                vid.controls = true;
                vid.style.maxWidth = '100%';
                vid.style.maxHeight = '50vh';
                container.appendChild(vid);

            } else if (['mp3', 'wav', 'mpeg'].includes(ext)) {
                // AUDIO (Musik)
                const audio = document.createElement('audio');
                audio.src = path;
                if(autoPlay) {
                    audio.autoplay = true;
                    // Versuch, Audio abzuspielen (kann vom Browser blockiert werden, wenn keine Interaktion stattfand)
                    audio.play().catch(e => console.log("Autoplay blockiert:", e));
                }
                audio.controls = true; // Steuerelemente anzeigen
                container.appendChild(audio);
                
                // Icon f√ºr Audio anzeigen
                const icon = document.createElement('div');
                icon.innerHTML = 'üéµ'; 
                icon.style.fontSize = '5rem';
                container.appendChild(icon);

            } else {
                // BILD
                const img = document.createElement('img');
                img.src = path;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '50vh';
                container.appendChild(img);
            }
        }

        // --- ZUR√úCK ZUM BOARD ---
        socket.on('board_hide_question', () => {
            document.getElementById('question-overlay').style.display = 'none';
            document.getElementById('media-container').innerHTML = "";
            
            // Audio stoppen (falls noch l√§uft)
            const audios = document.querySelectorAll('audio, video');
            audios.forEach(a => a.pause());
        });

        // --- STANDARD FUNKTIONEN ---
        function renderPlayerBar(playersData) {
            const bar = document.getElementById('player-bar');
            bar.innerHTML = "";
            for (const id in playersData) {
                const p = playersData[id];
                const div = document.createElement('div');
                div.className = 'player-card';
                div.id = 'p-' + id; 
                div.innerText = `${p.name} (${p.score})`; 
                bar.appendChild(div);
            }
        }

        function generateQrCode() {
            const url = window.location.href.replace('board.html', 'player.html');
            document.getElementById('join-url').innerText = url;
            const container = document.getElementById('qrcode-container');
            container.innerHTML = ''; 
            new QRCode(container, { text: url, width: 400, height: 400, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H });
        }

        function renderGrid() {
            const grid = document.getElementById('game-grid');
            grid.innerHTML = "";
            
            if(!currentGame || !currentGame.categories) return;

            grid.style.gridTemplateColumns = `repeat(${currentGame.categories.length}, 1fr)`;
            grid.style.display = "grid"; 
            
            const numQuestions = currentGame.categories[0]?.questions?.length || 5; 
            grid.style.gridTemplateRows = `0.5fr repeat(${numQuestions}, 1fr)`;

            currentGame.categories.forEach((cat, catIndex) => {
                const head = document.createElement('div');
                head.className = 'cat-header';
                head.innerText = cat.name;
                grid.appendChild(head);

                cat.questions.forEach((q, qIndex) => {
                    const card = document.createElement('div');
                    card.className = 'q-card';
                    card.innerText = q.points;
                    card.id = `card-${catIndex}-${qIndex}`; 
                    card.style.gridColumn = catIndex + 1;
                    card.style.gridRow = qIndex + 2; 
                    grid.appendChild(card);
                });
            });
        }

        // --- LISTENERS ---
        socket.on('load_game_on_board', (game) => {
            console.log('Quiz geladen:', game.title);
            currentGame = game;
            
            if (currentGame.boardBackgroundPath) {
                document.body.style.backgroundImage = `url(${currentGame.boardBackgroundPath})`;
            } else {
                document.body.style.backgroundImage = 'none'; 
                document.body.style.backgroundColor = '#1a1a1a'; 
            }
            renderGrid();
            
            // QR Code Logik beim Start
            const qrOverlay = document.getElementById('qr-overlay');
            generateQrCode(); 
            qrCodeVisible = true; 
            qrOverlay.style.display = 'flex'; 
        });

        socket.on('board_toggle_qr', () => {
            const qrOverlay = document.getElementById('qr-overlay');
            if (qrOverlay.style.display === 'none' || qrOverlay.style.display === '') {
                if (!qrCodeVisible) { generateQrCode(); qrCodeVisible = true; }
                qrOverlay.style.display = 'flex';
            } else {
                qrOverlay.style.display = 'none';
            }
        });
        
        socket.on('update_scores', renderPlayerBar);
        socket.on('update_player_list', renderPlayerBar); // Fallback
        
        socket.on('player_won_buzz', (data) => {
            document.querySelectorAll('.player-card').forEach(c => c.classList.remove('buzzing'));
            const winner = document.getElementById('p-' + data.id);
            if(winner) winner.classList.add('buzzing');
        });
        
        socket.on('buzzers_unlocked', () => {
             document.querySelectorAll('.player-card').forEach(c => c.classList.remove('buzzing'));
        });
    </script>
</body>
</html>