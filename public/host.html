<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Jeopardy Host</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #eee; display: flex; height: 95vh; gap: 20px; }

        /* Rechte Seite: Das aktive Spiel */
        #controls { 
            flex-grow: 1; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none; 
            flex-direction: column; 
        }
        
        /* Das Mini-Grid f√ºr den Host */
        #host-grid { 
            display: flex; 
            gap: 10px; 
            overflow-x: auto; 
            margin-bottom: 20px; 
            padding-bottom: 10px; 
            border-bottom: 2px solid #ddd; 
        }
        .host-col { flex: 1; min-width: 150px; display: flex; flex-direction: column; gap: 5px; }
        .host-cat-title { font-weight: bold; text-align: center; margin-bottom: 5px; }
        
        .q-btn {
            padding: 15px; background: #ddd; border: 1px solid #999; cursor: pointer; text-align: center; font-weight: bold;
        }
        .q-btn:hover { background: #ccc; }
        .q-btn.active { background: #007bff; color: white; } 
        .q-btn.done { background: #333; color: #888; text-decoration: line-through; } 

        /* Steuerleiste unten */
        #action-bar { margin-top: auto; padding-top: 20px; text-align: center; border-top: 2px solid #ddd; }
        #current-answer { 
            font-size: 1.5rem; 
            color: #d63384; 
            margin: 10px auto; /* Zentrieren */
            font-weight: bold; 
            min-height: 30px;
            
            /* NEU: Wichtig f√ºr lange W√∂rter ohne Leerzeichen */
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            
            max-width: 90%; /* Verhindert, dass es ganz an den Rand klatscht */
            line-height: 1.4;
        }
        
        button.big-btn { padding: 15px 30px; font-size: 1.2rem; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn-buzz { background: #dc3545; color: white; }
        .btn-close { background: #6c757d; color: white; }
        
        /* Visueller Stil f√ºr den aktiven QR-Code-Button */
        .is-on {
            background-color: #28a745; /* Gr√ºner Hintergrund f√ºr "Ein" */
            border-color: #28a745;
            color: white;
        }
        .is-on:hover {
            background-color: #1e7e34;
            border-color: #1e7e34;
        }
        
    </style>
</head>
<body>
    <div id="controls">
        <h2 id="game-title">Titel</h2>
        <button id="exit-quiz-btn" style="position: absolute; top: 10px; right: 10px; padding: 10px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">
            ‚ùå Quiz Verlassen
        </button>
        <div id="score-display"></div> <div id="host-grid"></div>

        <div id="action-bar">
            <div id="current-answer">W√§hle oben eine Frage aus...</div>
            <button class="secondary" id="qrCodeToggleButton" onclick="toggleQrCode()">
                QR-Code: Ein
            </button>
            <button class="big-btn btn-buzz" onclick="unlockBuzzers()">üö® BUZZER FREIGEBEN</button>
            <button class="big-btn btn-close" onclick="closeQuestion()">‚ùå FRAGE BEENDEN (Zur√ºck)</button>
        </div>
        <div id="map-controls" style="display:none; background:#eef; padding:10px; border-radius:5px; margin-top:10px;">
            <h4>Karten-Frage l√§uft...</h4>
            <p>Abgegeben: <span id="map-submitted-count">0</span> / <span id="map-total-count">?</span></p>
            <button onclick="resolveMap()" style="background:#007bff; color:white; padding:10px; width:100%;">
                üåç AUFL√ñSEN & ANZEIGEN
            </button>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let activeGame = null;
        let currentPlayers = {}; 
        let currentBuzzWinnerId = null; 
        let activeQuestionPoints = 0; 
        let qrCodeIsVisible = true; // Statusvariable f√ºr den QR-Code-Zustand
        let currentAnswerText = "W√§hle oben eine Frage aus"; // Speichert den aktuellen Antworttext
        let activeQuestionPicked = false; // Flag, ob eine Frage ge√∂ffnet ist
        let currentRoomCode = null;

        // Wird aufgerufen, wenn Host ein Spiel ausw√§hlt
        async function loadGame(gameId) {
            // Server bitten, eine Session zu starten
            socket.emit('host_create_session', gameId);
        }

        socket.on('session_created', async (roomCode) => {
            currentRoomCode = roomCode;
            const gameId = new URLSearchParams(window.location.search).get('gameId');

            // Titel updaten
            const titleEl = document.getElementById('game-title');
            if(titleEl) titleEl.innerText = `Raum-Code: ${roomCode}`;

            const boardUrl = `/board.html?room=${roomCode}`;

            // Link zum Board updaten
            const boardBtn = document.getElementById('open-board-btn');
            if(boardBtn) {
                boardBtn.onclick = () => window.open(boardUrl, 'jeopardy_board');
                boardBtn.style.display = 'inline-block';
                boardBtn.innerText = "üì∫ BOARD √ñFFNEN"; // Text deutlicher machen
                // Button auff√§llig stylen, falls Popup geblockt wurde
                boardBtn.style.backgroundColor = "#28a745"; 
                boardBtn.style.transform = "scale(1.1)";
            }
            // 2. Versuch: Automatisch √∂ffnen
            try {
                const newWindow = window.open(boardUrl, 'jeopardy_board');
                // Pr√ºfen, ob der Popup-Blocker zugeschlagen hat
                if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                    console.log("Popup wurde blockiert. Nutzer muss manuell klicken.");
                    alert("Der Browser hat das Board-Fenster blockiert. Bitte klicken Sie oben auf 'BOARD √ñFFNEN'.");
                }
            } catch (e) {
                console.error("Fehler beim √ñffnen des Boards:", e);
            }
            // Daten laden
            try {
                const res = await fetch(`/api/games/${gameId}`);
                if(!res.ok) throw new Error("Fehler beim Laden");
                
                const game = await res.json();
                currentGameData = game; // Speichern
                
                // Grid rendern
                renderHostGrid(game);

            } catch (e) {
                console.error(e);
                alert("Konnte Spieldaten nicht laden.");
            }
        });

        // --- SCORE RENDERING ---
        function renderScores() {
            let html = '<h4>Scores</h4><div style="display:flex; flex-wrap:wrap; gap:15px;">';
            for (const id in currentPlayers) {
                const p = currentPlayers[id];
                html += `<div style="padding: 5px 10px; border: 1px solid #ccc; border-radius: 4px; background: #f0f0f0;">
                            <strong>${p.name}:</strong> ${p.score}
                        </div>`;
            }
            html += '</div>';
            
            const scoreDisplay = document.getElementById('score-display');
            if(scoreDisplay) {
                scoreDisplay.innerHTML = html;
            }
        }
        
        socket.on('update_scores', (players) => {
            currentPlayers = players;
            renderScores();
        });
        
        // NEU: Host-Steuerung aktualisieren (z.B. Buzzer-Gewinner)
        socket.on('update_host_controls', (data) => {
            console.log("Host Controls Update erhalten:", data); 
            
            const answerDisplay = document.getElementById('current-answer');
            const controlsDiv = document.getElementById('controls-div'); 
            
            // Alte Scoring-Buttons sicherheitshalber entfernen
            document.querySelectorAll('.scoring-btn').forEach(btn => btn.remove());

            if (data.buzzWinnerId) {
                // KORREKTUR: Name direkt aus den Daten oder aus currentPlayers holen
                const winnerName = data.buzzWinnerName || currentPlayers[data.buzzWinnerId]?.name || 'Unbekannt';
                
                // Wichtig: Verwende den gespeicherten Text
                answerDisplay.innerHTML = `L√∂sung: <span style="color: #333; border-bottom: 2px solid #d63384;">${currentAnswerText}</span> <br><br>
                                <span style="color:red; font-size:2rem; display:block; margin-top:10px;">${winnerName} WILL ANTWORTEN!</span>`;
                
                // --- SCORING BUTTONS HINZUF√úGEN ---
                // (Dieser Teil fehlte oder war unvollst√§ndig in Ihrem Snippet im Socket-Handler)
                const actionBar = document.getElementById('action-bar');
                
                const correctBtn = document.createElement('button');
                correctBtn.className = 'big-btn scoring-btn';
                correctBtn.innerText = `‚úÖ Richtig (+${activeQuestionPoints || 0})`; // Fallback f√ºr Points
                correctBtn.style.background = '#28a745';
                correctBtn.onclick = () => scoreAnswer('correct', data.buzzWinnerId);
                actionBar.insertBefore(correctBtn, actionBar.firstChild);

                const incorrectBtn = document.createElement('button');
                incorrectBtn.className = 'big-btn scoring-btn';
                incorrectBtn.innerText = `‚ùå Falsch (-${activeQuestionPoints || 0})`;
                incorrectBtn.style.background = '#dc3545';
                incorrectBtn.onclick = () => scoreAnswer('incorrect', data.buzzWinnerId);
                actionBar.insertBefore(incorrectBtn, actionBar.firstChild);

            } else if (activeQuestionPicked) {
                // FRAGE AKTIV, ABER KEIN GEWINNER
                answerDisplay.innerText = "L√∂sung: " + currentAnswerText;
                
            } else {
                // KEINE FRAGE AKTIV
                answerDisplay.innerText = "W√§hle oben eine Frage aus";
            }

            if (data.mapMode) {
                document.getElementById('map-controls').style.display = 'block';
                document.getElementById('map-submitted-count').innerText = data.submittedCount || 0;
                // Verstecke normale Scoring Buttons
                document.querySelectorAll('.scoring-btn').forEach(b => b.style.display = 'none');
            } else {
                document.getElementById('map-controls').style.display = 'none';
            }
        });

        socket.on('host_update_map_status', (data) => {
            document.getElementById('map-submitted-count').innerText = data.submittedCount;
            document.getElementById('map-total-count').innerText = data.totalPlayers;
        });

        function resolveMap() {
            socket.emit('host_resolve_map');
            // Optional: Button deaktivieren oder Text √§ndern
        }
        
        // Buzzer Gewinner anzeigen und Scoring-Buttons bereitstellen
        function updateAnswerBar(data) {
            const bar = document.getElementById('current-answer');
            const actionBar = document.getElementById('action-bar');
            
            // Scoring-Buttons entfernen (falls schon vorhanden)
            const oldBtns = document.querySelectorAll('.scoring-btn');
            oldBtns.forEach(btn => btn.remove());
            
            if (data.buzzWinnerId) {
                // Die korrekte Antwort wird vom Server/Frontend nicht automatisch gesendet, 
                // daher suchen wir sie im activeGame Objekt.
                let currentAnswerText = "L√∂sung nicht verf√ºgbar";
                
                // Wir nehmen die Antwort von der Frage, die aktuell als "active" markiert ist.
                const activeBtn = document.querySelector('.q-btn.active');
                if (activeBtn) {
                     // Die ID des Buttons ist card-catIndex-qIndex
                     const [ , catIndex, qIndex ] = activeBtn.id.split('-');
                     if (activeGame && activeGame.categories[catIndex] && activeGame.categories[catIndex].questions[qIndex]) {
                         currentAnswerText = activeGame.categories[catIndex].questions[qIndex].answerText;
                     }
                }
                
                // Nutzen Sie <span> oder <strong> statt Sternchen f√ºr die Formatierung
                bar.innerHTML = `L√∂sung: <span style="color: #333; border-bottom: 2px solid #d63384;">${currentAnswerText}</span> <br><br>
                        <span style="color:red; font-size:2rem; display:block; margin-top:10px;">${data.buzzWinnerName} WILL ANTWORTEN!</span>`;    
                
                // Scoring Buttons hinzuf√ºgen
                const correctBtn = document.createElement('button');
                correctBtn.className = 'big-btn scoring-btn';
                correctBtn.innerText = `‚úÖ Richtig (+${activeQuestionPoints})`;
                correctBtn.style.background = '#28a745';
                correctBtn.onclick = () => scoreAnswer('correct', data.buzzWinnerId);
                actionBar.insertBefore(correctBtn, actionBar.firstChild);

                const incorrectBtn = document.createElement('button');
                incorrectBtn.className = 'big-btn scoring-btn';
                incorrectBtn.innerText = `‚ùå Falsch (-${activeQuestionPoints})`;
                incorrectBtn.style.background = '#dc3545';
                incorrectBtn.onclick = () => scoreAnswer('incorrect', data.buzzWinnerId);
                actionBar.insertBefore(incorrectBtn, actionBar.firstChild);
            
            } else {
                bar.innerText = "W√§hle oben eine Frage aus...";
            }
        }
        
        function scoreAnswer(action, playerId) {
            document.querySelectorAll('.scoring-btn').forEach(btn => btn.remove());
            
            socket.emit('host_score_answer', {
                action: action,
                playerId: playerId
            });
        }
        
        // --- QUIZ VERWALTUNG ---
        
        function loadGame(gameId) {
            document.getElementById('controls').style.display = 'flex';
            const title = getTitleFromUrl();
            document.getElementById('game-title').innerText = title;
            // Sicherstellen, dass der Score-Anzeiger existiert
            if(!document.getElementById('score-display')) {
                const newDiv = document.createElement('div');
                newDiv.id = 'score-display';
                document.getElementById('controls').insertBefore(newDiv, document.getElementById('host-grid'));
            }
            // WICHTIG: Befehl an Server -> voller Ladevorgang
            socket.emit('host_start_game', gameId); 
        }

        // Wenn Server das volle Spiel zur√ºckschickt, rendern wir das Host-Grid
        socket.on('load_game_on_board', (game) => {
            console.log("Host: Quizdaten empfangen und rendere Grid.", game.title); // <-- DIAGNOSE
            activeGame = game;
            renderHostGrid();
            renderScores();
        });

        // --- FUNKTION: HOST GRID RENDERN ---
        function renderHostGrid(game) {
            const grid = document.getElementById('host-grid');
            grid.innerHTML = ''; // Leeren

            if (!game.categories || game.categories.length === 0) {
                grid.innerHTML = '<p style="padding:20px;">Keine Fragen in diesem Spiel.</p>';
                return;
            }

            game.categories.forEach((cat, catIndex) => {
                const col = document.createElement('div');
                col.className = 'host-col';
                
                const title = document.createElement('div');
                title.className = 'host-cat-title';
                title.innerText = cat.name;
                col.appendChild(title);

                cat.questions.forEach((q, qIndex) => {
                    const btn = document.createElement('button');
                    btn.className = 'q-btn';
                    btn.innerText = q.points;
                    btn.onclick = () => {
                        // Buttons deaktivieren
                        document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        // Frage an Server senden
                        socket.emit('host_pick_question', { catIndex, qIndex, question: q });
                    };
                    col.appendChild(btn);
                });
                grid.appendChild(col);
            });
            
            // Controls anzeigen
            document.getElementById('controls').style.display = 'flex';
        }

        // --- SPIEL-STEUERUNG (BUZZER/RUNDE) ---
        function unlockBuzzers() {
            document.querySelectorAll('.scoring-btn').forEach(btn => btn.remove());
            socket.emit('host_unlock_buzzers');
        }

        function closeQuestion() {
            document.querySelectorAll('.scoring-btn').forEach(btn => btn.remove());
            socket.emit('host_close_question');

            currentAnswerText = "W√§hle oben eine Frage aus"; 
            activeQuestionPicked = false;

            document.getElementById('current-answer').innerText = "---";
            
            const activeBtn = document.querySelector('.q-btn.active');
            if(activeBtn) {
                activeBtn.classList.remove('active');
                activeBtn.classList.add('done');
            }
            
        }
        
        function toggleQrCode() {
            const button = document.getElementById('qrCodeToggleButton');
            
            // 1. Status umschalten
            qrCodeIsVisible = !qrCodeIsVisible;

            // 2. Button-Text basierend auf dem neuen Status anpassen
            if (qrCodeIsVisible) {
                button.innerText = 'QR-Code: Ein';
                button.classList.add('active-toggle'); // Optional: Visuellen Hinweis geben
            } else {
                button.innerText = 'QR-Code: Aus';
                button.classList.remove('active-toggle');
            }

            // 3. Signal an den Server senden
            socket.emit('host_toggle_qr');
            console.log(`Signal gesendet: QR-Code ist jetzt ${qrCodeIsVisible ? 'sichtbar' : 'versteckt'}.`);
        }

        socket.on('player_won_buzz', (data) => {
             // Dient nur noch als Konsolen-Log, die Hauptsteuerung l√§uft √ºber update_host_controls
             console.log(`Buzzer gewonnen: ${data.name}`);
        });

        document.getElementById('exit-quiz-btn').addEventListener('click', () => {
            if (confirm("M√∂chten Sie das Quiz wirklich beenden?")) {
                // Optionale: Hier k√∂nnten Sie Socket.io-Events senden, um das Spiel auf allen Clients zu beenden.
                // socket.emit('host_end_game'); 
                
                // Zur√ºck zur Startseite (create.html)
                window.location.href = '/create.html'; 
            }
        });
        function getGameIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('gameId');
        }
        function getTitleFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('title');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const gameId = urlParams.get('gameId');

            if (!gameId) {
                alert("Fehler: Keine Game-ID √ºbergeben!");
                window.location.href = '/create.html';
                return;
            }

            // Session beim Server anfordern
            socket.emit('host_create_session', gameId);
        });

        document.getElementById('exit-quiz-btn').addEventListener('click', () => {
            if(confirm("Session wirklich beenden?")) {
                socket.emit('host_end_session');
                window.location.href = '/create.html';
            }
        });
    </script>
</body>
</html>